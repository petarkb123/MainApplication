<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a30">
    <title>FitPower - Advanced Analytics</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/component-layout.css}">
    <link rel="stylesheet" th:href="@{/css/component-sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/component-buttons.css}">
    <link rel="stylesheet" th:href="@{/css/component-forms.css}">
    <link rel="stylesheet" th:href="@{/css/component-modals.css}">
    <link rel="stylesheet" th:href="@{/css/component-headers.css}">
    <link rel="stylesheet" th:href="@{/css/component-profile.css}">
    <link rel="stylesheet" th:href="@{/css/advanced-stats.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script th:inline="javascript">
        window.__pageDataAdvancedStats = {
            dayOfWeekData: {},
            weeklyBreakdown: [],
            volumeTrends: [],
            progressiveOverload: []
        };
    </script>
    <script th:src="@{/js/advanced-stats.js}"></script>
</head>
<body>
<div class="dashboard-container">
    
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="logo">
                <i class="fas fa-dumbbell"></i>
                <span>FitPower</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">MAIN MENU</h3>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="/dashboard" class="nav-link">
                            <i class="fas fa-th-large"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/exercises" class="nav-link">
                            <i class="fas fa-dumbbell"></i>
                            <span>Exercises</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/workouts" class="nav-link">
                            <i class="fas fa-history"></i>
                            <span>Workouts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/templates" class="nav-link">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Templates</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="/stats/weekly" class="nav-link">
                            <i class="fas fa-chart-line"></i>
                            <span>Statistics</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">ACCOUNT</h3>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="/subscription" class="nav-link">
                            <i class="fas fa-crown"></i>
                            <span>Subscription</span>
                        </a>
                    </li>
                    <li class="nav-item" th:if="${isAdmin}">
                        <a href="/admin/users" class="nav-link">
                            <i class="fas fa-users-cog"></i>
                            <span>Admin Panel</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/settings" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <form th:action="@{/logout}" method="post" style="display:inline;">
                            <button type="submit" class="nav-link" style="background:none; border:none; width:100%; text-align:left;">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        </form>
                    </li>
                </ul>
            </div>
        </nav>
    </aside>

    
    <main class="main-content">
        
        <header class="top-header">
            <div class="header-left">
                <div class="user-profile mobile-profile">
                    <div class="profile-avatar avatar-preview">
                        <img th:if="${navAvatar}" th:src="${navAvatar}" alt="Profile Picture" class="avatar-image">
                        <div class="avatar-placeholder" th:unless="${navAvatar}" style="display:flex;">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <span class="profile-name" th:text="${username}">User</span>
                    </div>
                </div>
                <h1 class="page-title">Advanced Analytics</h1>
            </div>
            <div class="header-right">
                <div class="user-profile desktop-profile">
                    <div class="profile-avatar avatar-preview">
                        <img th:if="${navAvatar}" th:src="${navAvatar}" alt="Profile Picture" class="avatar-image">
                        <div class="avatar-placeholder" th:unless="${navAvatar}" style="display:flex;">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <span class="profile-name" th:text="${username}">User</span>
                    </div>
                </div>
                <div class="header-actions">
                    <a href="/settings" class="header-btn">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                    <form th:action="@{/logout}" method="post" style="display:inline; margin:0;">
                        <button type="submit" class="header-btn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    </form>
                </div>
            </div>
        </header>

        
        <div class="dashboard-content">

            <style>
                .stats-grid.stats-grid--three {
                    display: grid;
                    grid-template-columns: repeat(3, minmax(0, 1fr));
                    gap: 18px;
                }
                @media (max-width: 768px) {
                    .stats-grid.stats-grid--three {
                        grid-template-columns: repeat(1, minmax(0, 1fr));
                    }
                }
            </style>
            
            <div th:if="${analyticsMessage != null}" class="flash-message success"
                 style="margin-bottom:16px;padding:14px 18px;border-radius:10px;background:rgba(46,213,115,0.12);color:#aef1c6;border:1px solid rgba(46,213,115,0.4);">
                <i class="fas fa-check-circle" style="margin-right:8px;"></i>
                <span th:text="${analyticsMessage}">Action completed</span>
            </div>
            <div th:if="${analyticsError != null}" class="flash-message error"
                 style="margin-bottom:16px;padding:14px 18px;border-radius:10px;background:rgba(255,82,82,0.12);color:#ffb4b4;border:1px solid rgba(255,82,82,0.4);">
                <i class="fas fa-exclamation-triangle" style="margin-right:8px;"></i>
                <span th:text="${analyticsError}">Something went wrong</span>
            </div>
            <div th:if="${microserviceAvailable != null && !microserviceAvailable}" class="flash-message warning"
                 style="margin-bottom:16px;padding:14px 18px;border-radius:10px;background:rgba(255,152,0,0.12);color:#ffcc80;border:1px solid rgba(255,152,0,0.4);">
                <i class="fas fa-exclamation-triangle" style="margin-right:8px;"></i>
                <span>Analytics microservice is currently unavailable. Some data may not be displayed. Please ensure the microservice is running on port 8083.</span>
            </div>
            
            <div class="page-header">
                <div class="page-title-section">
                    <a href="/stats/weekly" class="back-link">
                        <i class="fas fa-arrow-left"></i>
                        Back to Statistics
                    </a>
                    <h1 class="page-title">
                        <i class="fas fa-chart-pie"></i>
                        Advanced Training Data Analysis
                    </h1>
                    <p class="page-subtitle">Deep insights into your training performance and progress</p>
                    <div class="date-range-display">
                        <i class="fas fa-calendar-alt"></i>
                        <span th:text="${#temporals.format(from, 'MMM dd, yyyy')} + ' - ' + ${#temporals.format(to, 'MMM dd, yyyy')}">Date Range</span>
                    </div>
                </div>
            </div>

            
            <section class="analytics-section">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-check"></i> Training Frequency Analysis</h2>
                    <p class="section-subtitle">How often you train and your consistency patterns</p>
                </div>

                <div class="stats-grid stats-grid--three">
                    <div class="stat-card highlight">
                        <div class="stat-icon">
                            <i class="fas fa-dumbbell"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Total Workouts</div>
                            <div class="stat-value" th:text="${trainingFrequency.totalWorkouts}">0</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Longest Streak</div>
                            <div class="stat-value" th:text="${trainingFrequency.longestStreak} + ' days'">0 days</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Current Streak</div>
                            <div class="stat-value" th:text="${trainingFrequency.currentStreak} + ' days'">0 days</div>
                        </div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Workouts by Day of Week</h3>
                        <canvas id="dayOfWeekChart"></canvas>
                    </div>

                    <div class="chart-card">
                        <h3>Weekly Breakdown</h3>
                        <canvas id="weeklyBreakdownChart"></canvas>
                    </div>
                </div>
            </section>

            
             
            <section class="analytics-section" th:if="${!progressiveOverload.isEmpty()}">
                <div class="section-header">
                    <h2><i class="fas fa-chart-area"></i> Progressive Overload Tracking</h2>
                    <p class="section-subtitle">Monitor strength gains and identify plateaus</p>
                </div>

                <div class="overload-grid">
                    <div class="overload-card" th:each="overload, overloadStat : ${progressiveOverload}">
                        <div class="overload-header">
                            <div class="overload-title">
                                <h3 th:text="${overload.exerciseName}">Exercise</h3>
                                <span class="muscle-badge" th:text="${overload.muscleGroup}">Muscle</span>
                            </div>
                            <div class="status-badge" th:classappend="${overload.status}">
                                <i class="fas" th:classappend="${overload.status == 'progressing' ? 'fa-rocket' : (overload.status == 'plateau' ? 'fa-pause' : 'fa-check')}"></i>
                                <span th:text="${overload.status}">Status</span>
                            </div>
                        </div>

                        <div class="overload-progress">
                            <div class="progress-info">
                                <div class="progress-item">
                                    <span class="progress-label">Starting Weight</span>
                                    <span class="progress-value" th:text="${overload.startingWeight != null ? (#numbers.formatDecimal(overload.startingWeight, 0, 'COMMA', 0, 'POINT') + ' lbs') : '0 lbs'}">0 lbs</span>
                                </div>
                                <div class="progress-arrow">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                                <div class="progress-item">
                                    <span class="progress-label">Current Weight</span>
                                    <span class="progress-value" th:text="${overload.currentWeight != null ? (#numbers.formatDecimal(overload.currentWeight, 0, 'COMMA', 0, 'POINT') + ' lbs') : '0 lbs'}">0 lbs</span>
                                </div>
                            </div>
                            <div class="progress-percent" th:classappend="${overload.progressPercent > 0 ? 'positive' : 'neutral'}">
                                <i class="fas fa-arrow-up" th:if="${overload.progressPercent > 0}"></i>
                                <i class="fas fa-minus" th:if="${overload.progressPercent == 0}"></i>
                                <span th:text="${overload.progressPercent} + '%'">0%</span>
                            </div>
                        </div>

                        <div class="overload-chart">
                            <canvas th:id="'overloadChart' + ${overloadStat.index}" class="overload-chart-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="analytics-section" th:if="${!volumeTrends.isEmpty()}">
                <div class="section-header">
                    <h2><i class="fas fa-weight-hanging"></i> Exercise Volume Trends</h2>
                    <p class="section-subtitle">Track volume progression for each exercise over time</p>
                </div>

                <div class="exercise-trends-list">
                    <div class="trend-card" th:each="trend, trendStat : ${volumeTrends}">
                        <div class="trend-header">
                            <div class="trend-title">
                                <h3 th:text="${trend.exerciseName}">Exercise Name</h3>
                                <span class="muscle-badge" th:text="${trend.muscleGroup}">Muscle</span>
                            </div>
                            <div class="trend-indicator" th:classappend="${trend.trend}">
                                <i class="fas" th:classappend="${trend.trend == 'increasing' ? 'fa-arrow-up' : (trend.trend == 'decreasing' ? 'fa-arrow-down' : 'fa-minus')}"></i>
                                <span th:text="${trend.trend}">Trend</span>
                            </div>
                        </div>

                        <div class="trend-stats">
                            <div class="trend-stat">
                                <span class="trend-stat-label">Total Volume</span>
                                <span class="trend-stat-value" th:text="${trend.totalVolume != null ? (#numbers.formatDecimal(trend.totalVolume, 0, 'COMMA', 0, 'POINT') + ' lbs') : '0 lbs'}">0 lbs</span>
                            </div>
                            <div class="trend-stat">
                                <span class="trend-stat-label">Total Sets</span>
                                <span class="trend-stat-value" th:text="${trend.totalSets}">0</span>
                            </div>
                            <div class="trend-stat">
                                <span class="trend-stat-label">Avg Per Session</span>
                                <span class="trend-stat-value" th:text="${trend.avgVolumePerSession != null ? (#numbers.formatDecimal(trend.avgVolumePerSession, 0, 'COMMA', 0, 'POINT') + ' lbs') : '0 lbs'}">0 lbs</span>
                            </div>
                        </div>

                        <div class="trend-chart">
                            <canvas th:id="'volumeChart' + ${trendStat.index}" class="volume-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

           

            
            <section class="analytics-section">
                <div class="section-header">
                    <h2><i class="fas fa-trophy"></i> Personal Records & Milestones</h2>
                    <p class="section-subtitle">Your achievements and personal bests</p>
                </div>

                <div class="milestone-actions-card" style="background:rgba(21,26,48,0.85);border:1px solid rgba(102,126,234,0.2);border-radius:14px;padding:18px;margin-bottom:24px;">
                    <h3 style="margin-bottom:12px;font-size:1.1rem;">‚ú® Add Custom Milestone</h3>
                    <form th:action="@{/stats/milestones}" method="post" class="milestone-form" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;align-items:end;">
                        <div style="display:flex;flex-direction:column;gap:6px;">
                            <label for="milestoneTitle">Title</label>
                            <input id="milestoneTitle" name="title" type="text" placeholder="e.g. First Half-Marathon" required
                                   style="padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(12,16,30,0.9);color:#fff;">
                        </div>
                        <div style="display:flex;flex-direction:column;gap:6px;">
                            <label for="milestoneType">Type</label>
                            <select id="milestoneType" name="type" required
                                    style="padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(12,16,30,0.9);color:#fff;">
                                <option th:each="type : ${milestoneTypes}"
                                        th:value="${type}"
                                        th:text="${#strings.replace(type.name(), '_', ' ')}">TYPE</option>
                            </select>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:6px;">
                            <label for="milestoneDate">Achieved On</label>
                            <input id="milestoneDate" name="achievedDate" type="date" th:value="${today}"
                                   style="padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(12,16,30,0.9);color:#fff;">
                        </div>
                        <div style="display:flex;flex-direction:column;gap:6px;">
                            <label for="milestoneDescription">Description</label>
                            <textarea id="milestoneDescription" name="description" rows="1" placeholder="Optional details"
                                      style="padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(12,16,30,0.9);color:#fff;"></textarea>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:6px;">
                            <label style="visibility:hidden;">Submit</label>
                            <button type="submit" class="primary-btn"
                                    style="padding:12px;border-radius:10px;border:none;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:600;">
                                Save Milestone
                            </button>
                        </div>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    </form>
                    <small style="display:block;margin-top:10px;color:rgba(255,255,255,0.6);">
                        Tip: milestones unlocked automatically stay read-only; custom milestones you add here can be managed below.
                    </small>
                </div>

                
                <div class="milestones-section" th:if="${personalRecords != null && !personalRecords.milestones.isEmpty()}">
                    <h3>üèÜ Milestones Achieved</h3>
                    <div class="milestones-grid">
                        <div class="milestone-card" th:each="milestone : ${personalRecords.milestones}">
                            <div class="milestone-icon" th:text="${milestone.icon}">üèÜ</div>
                            <div class="milestone-content">
                                <h4 th:text="${milestone.title}">Milestone Title</h4>
                                <p th:text="${milestone.description}">Description</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="milestones-section" th:if="${personalRecords == null || personalRecords.milestones.isEmpty()}">
                    <div class="empty-state" style="padding:18px;border-radius:12px;border:1px dashed rgba(255,255,255,0.2);background:rgba(26,32,54,0.6);color:rgba(255,255,255,0.7);">
                        <i class="fas fa-flag-checkered" style="margin-right:8px;"></i>
                        No milestones yet. Log workouts or add your first custom milestone above.
                    </div>
                </div>

                <div class="custom-milestones" th:if="${!milestoneDtos.isEmpty()}"
                     style="margin-top:24px;">
                    <h3 style="margin-bottom:12px;">üóÇ Manage Saved Milestones</h3>
                    <div class="milestones-grid">
                        <div class="milestone-card manageable" th:each="milestone : ${manageableMilestones}">
                            <div class="milestone-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="milestone-content">
                                <h4 th:text="${milestone.title}">Title</h4>
                                <p th:text="${milestone.description != null ? milestone.description : 'No description provided.'}">Description</p>
                                <div class="milestone-meta" style="display:flex;gap:10px;font-size:0.85rem;color:rgba(255,255,255,0.6);">
                                    <span><i class="fas fa-calendar-alt"></i>
                                        <span th:text="${#temporals.format(milestone.achievedDate, 'MMM dd, yyyy')}">Date</span></span>
                                    <span><i class="fas fa-tag"></i>
                                        <span th:text="${#strings.replace(milestone.type.name, '_', ' ')}">TYPE</span></span>
                                </div>
                            </div>
                            <form th:action="@{/stats/milestones/{id}/delete(id=${milestone.id})}" method="post"
                                  style="margin-left:auto;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button type="submit" class="danger-btn"
                                        style="padding:10px 14px;border-radius:8px;border:1px solid rgba(255,82,82,0.4);background:rgba(255,82,82,0.15);color:#ffb4b4;font-weight:600;">
                                    Remove
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="custom-milestones" th:if="${manageableMilestones.isEmpty()}"
                     style="margin-top:24px;">
                    <div class="empty-state" style="padding:18px;border-radius:12px;border:1px dashed rgba(255,255,255,0.2);background:rgba(26,32,54,0.6);color:rgba(255,255,255,0.7);">
                        <i class="fas fa-lightbulb" style="margin-right:8px;"></i>
                        <span th:if="${hasSystemMilestones}">
                            All current milestones are automatically managed by the app. Add a custom milestone above to manage it here.
                        </span>
                        <span th:unless="${hasSystemMilestones}">
                            There are no stored custom milestones yet. Use the form above to create one.
                        </span>
                    </div>
                </div>

                
                <div class="prs-section" th:if="${personalRecords != null && !personalRecords.exercisePRs.isEmpty()}">
                    <h3>üí™ Exercise Personal Records</h3>
                    <div class="prs-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Exercise</th>
                                    <th>Record Type</th>
                                    <th>Weight</th>
                                    <th>Reps</th>
                                    <th>Date Achieved</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="pr : ${personalRecords.exercisePRs}">
                                    <td>
                                        <strong th:text="${pr.exerciseName}">Exercise</strong>
                                    </td>
                                    <td>
                                        <span class="record-type-badge" th:text="${pr.recordType}">Type</span>
                                    </td>
                                    <td th:text="${pr.weight != null ? (#numbers.formatDecimal(pr.weight, 0, 'COMMA', 0, 'POINT') + ' lbs') : '0 lbs'}">0 lbs</td>
                                    <td th:text="${pr.reps != null ? pr.reps : 0}">0</td>
                                    <td th:text="${#temporals.format(pr.achievedDate, 'MMM dd, yyyy')}">Date</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </div>
    </main>
</div>

</body>
</html>
